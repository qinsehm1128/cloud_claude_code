# ============================================
# Host Nginx Configuration Template (Reference)
# 宿主机 Nginx 配置模板（参考）
# ============================================
#
# 推荐使用自动生成 / Recommended: Use auto-generation
#   ./generate-nginx.sh
#
# 手动配置时参考此文件 / Use this as reference for manual config
#
# 端口说明 / Port mapping:
#   APP_PORT (default 8080)     -> 主应用 / Main app
#   TRAEFIK_HTTP_PORT (8081)    -> Code-Server 代理 / Code-server proxy
#   TRAEFIK_DASHBOARD_PORT (8082) -> Traefik 仪表板 / Dashboard
#
# ============================================

# ===========================================
# Main Site / 主站点
# ===========================================
server {
    listen 80;
    server_name YOUR_DOMAIN;  # 改为你的域名，如 cc.example.com

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_types text/plain text/css text/xml text/javascript
               application/javascript application/json application/xml
               application/wasm image/svg+xml;
    gzip_comp_level 6;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;

    # Proxy to Docker frontend container
    # 代理到 Docker 前端容器
    location / {
        proxy_pass http://127.0.0.1:8080;  # APP_PORT
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support (for terminal and headless chat)
        # WebSocket 支持（用于终端和无头聊天）
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Timeouts for long connections
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        # Disable buffering for real-time
        proxy_buffering off;

        # Large file upload
        client_max_body_size 100m;
    }

    # Let's Encrypt
    location ~ \.well-known {
        allow all;
    }

    access_log /var/log/nginx/cc-platform.log;
    error_log /var/log/nginx/cc-platform.error.log;
}

# ===========================================
# Code-Server Subdomains / Code-Server 子域名
# ===========================================
# DNS: *.code.example.com -> Server IP
#
server {
    listen 80;
    server_name ~^(?<container>.+)\.code\.YOUR_CODE_DOMAIN$;  # 如 *.code.example.com

    location / {
        proxy_pass http://127.0.0.1:8081;  # TRAEFIK_HTTP_PORT
        proxy_http_version 1.1;

        # Keep Host for Traefik routing
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket (required for code-server)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        proxy_buffering off;
        client_max_body_size 100m;
    }

    access_log /var/log/nginx/code-server.log;
    error_log /var/log/nginx/code-server.error.log;
}

# ===========================================
# HTTPS Configuration Example / HTTPS 配置示例
# ===========================================
# After certbot: sudo certbot --nginx -d YOUR_DOMAIN
#
# server {
#     listen 443 ssl http2;
#     server_name YOUR_DOMAIN;
#
#     ssl_certificate /etc/letsencrypt/live/YOUR_DOMAIN/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/YOUR_DOMAIN/privkey.pem;
#
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
#     ssl_prefer_server_ciphers off;
#
#     add_header Strict-Transport-Security "max-age=63072000" always;
#
#     # ... same location blocks as above ...
# }
#
# # HTTP to HTTPS redirect
# server {
#     listen 80;
#     server_name YOUR_DOMAIN;
#     return 301 https://$server_name$request_uri;
# }
