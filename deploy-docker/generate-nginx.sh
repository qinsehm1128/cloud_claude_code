#!/bin/bash
# ============================================
# Generate Host Nginx Configuration
# 生成宿主机 Nginx 配置
# ============================================
#
# 此脚本根据 .env 配置自动生成宿主机 nginx 配置文件
# This script generates host nginx config based on .env
#
# Usage / 使用方法:
#   ./generate-nginx.sh
#   sudo cp nginx-site.conf /etc/nginx/sites-available/cc-platform.conf
#   sudo ln -s /etc/nginx/sites-available/cc-platform.conf /etc/nginx/sites-enabled/
#   sudo nginx -t && sudo systemctl reload nginx
#
# ============================================

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Check .env exists
if [ ! -f ".env" ]; then
    echo -e "${RED}Error: .env file not found${NC}"
    echo "Please run: cp .env.example .env && nano .env"
    exit 1
fi

# Load .env
source .env

# Check required variables
if [ -z "$DOMAIN" ]; then
    echo -e "${RED}Error: DOMAIN is not set in .env${NC}"
    echo "Please set your domain, e.g.: DOMAIN=cc.example.com"
    exit 1
fi

# Set defaults
APP_PORT=${APP_PORT:-8080}
TRAEFIK_HTTP_PORT=${TRAEFIK_HTTP_PORT:-8081}
CODE_SERVER_BASE_DOMAIN=${CODE_SERVER_BASE_DOMAIN:-}

echo -e "${GREEN}Generating nginx configuration...${NC}"
echo "  Domain: $DOMAIN"
echo "  App Port: $APP_PORT"
echo "  Traefik Port: $TRAEFIK_HTTP_PORT"
if [ -n "$CODE_SERVER_BASE_DOMAIN" ]; then
    echo "  Code-Server Domain: *.$CODE_SERVER_BASE_DOMAIN"
fi

# Generate nginx config
cat > nginx-site.conf << EOF
# ============================================
# CC Platform Nginx Configuration
# Auto-generated by generate-nginx.sh
# 由 generate-nginx.sh 自动生成
# ============================================

# ===========================================
# Main Site / 主站点
# ===========================================
server {
    listen 80;
    server_name ${DOMAIN};

    # Gzip
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_types text/plain text/css text/xml text/javascript
               application/javascript application/json application/xml
               application/wasm image/svg+xml;
    gzip_comp_level 6;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;

    # Proxy to Docker frontend
    location / {
        proxy_pass http://127.0.0.1:${APP_PORT};
        proxy_http_version 1.1;

        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;

        # WebSocket support
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        proxy_buffering off;
        client_max_body_size 100m;
    }

    # Let's Encrypt
    location ~ \.well-known {
        allow all;
    }

    access_log /var/log/nginx/${DOMAIN}.log;
    error_log /var/log/nginx/${DOMAIN}.error.log;
}
EOF

# Add code-server subdomain config if configured
if [ -n "$CODE_SERVER_BASE_DOMAIN" ]; then
    cat >> nginx-site.conf << EOF

# ===========================================
# Code-Server Subdomains / Code-Server 子域名
# ===========================================
# DNS required: *.${CODE_SERVER_BASE_DOMAIN} -> Server IP
server {
    listen 80;
    server_name ~^(?<container>.+)\.${CODE_SERVER_BASE_DOMAIN//./\\.}\$;

    location / {
        proxy_pass http://127.0.0.1:${TRAEFIK_HTTP_PORT};
        proxy_http_version 1.1;

        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;

        # WebSocket (required for code-server)
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        proxy_buffering off;
        client_max_body_size 100m;
    }

    access_log /var/log/nginx/code-server.log;
    error_log /var/log/nginx/code-server.error.log;
}
EOF
fi

echo ""
echo -e "${GREEN}Generated: nginx-site.conf${NC}"
echo ""
echo -e "${YELLOW}Next steps / 下一步:${NC}"
echo ""
echo "1. Copy to nginx config directory / 复制到 nginx 配置目录:"
echo "   sudo cp nginx-site.conf /etc/nginx/sites-available/cc-platform.conf"
echo ""
echo "2. Enable the site / 启用站点:"
echo "   sudo ln -s /etc/nginx/sites-available/cc-platform.conf /etc/nginx/sites-enabled/"
echo ""
echo "3. Test and reload / 测试并重载:"
echo "   sudo nginx -t && sudo systemctl reload nginx"
echo ""

if [ -n "$CODE_SERVER_BASE_DOMAIN" ]; then
    echo -e "${YELLOW}DNS Configuration / DNS 配置:${NC}"
    echo "  A record: ${DOMAIN} -> Your Server IP"
    echo "  A record: *.${CODE_SERVER_BASE_DOMAIN} -> Your Server IP"
    echo ""
fi

echo -e "${YELLOW}SSL Configuration (recommended) / SSL 配置（推荐）:${NC}"
echo "  sudo apt install certbot python3-certbot-nginx"
echo "  sudo certbot --nginx -d ${DOMAIN}"
if [ -n "$CODE_SERVER_BASE_DOMAIN" ]; then
    echo "  sudo certbot certonly --manual --preferred-challenges dns -d \"*.${CODE_SERVER_BASE_DOMAIN}\""
fi
