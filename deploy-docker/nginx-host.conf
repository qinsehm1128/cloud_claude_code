# ============================================
# Host Nginx Configuration Template
# 宿主机 Nginx 配置模板
# ============================================
#
# This configuration is for the HOST machine's Nginx,
# NOT the Nginx inside Docker containers.
#
# 此配置用于宿主机的 Nginx，不是 Docker 容器内的 Nginx。
#
# Setup steps / 配置步骤:
#   1. Copy this file to /etc/nginx/sites-available/cc-platform.conf
#   2. Edit the file and replace placeholders
#   3. Create symlink: ln -s /etc/nginx/sites-available/cc-platform.conf /etc/nginx/sites-enabled/
#   4. Test config: nginx -t
#   5. Reload: systemctl reload nginx
#
# Required DNS records / 需要的 DNS 记录:
#   - A record: example.com -> Server IP
#   - A record (wildcard): *.code.example.com -> Server IP
#
# ============================================

# ===========================================
# Main Site / 主站点
# ===========================================
server {
    listen 80;
    server_name YOUR_DOMAIN;  # e.g., cc.example.com

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_types text/plain text/css text/xml text/javascript
               application/javascript application/json application/xml
               application/wasm image/svg+xml;
    gzip_comp_level 6;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Proxy to Docker frontend container
    # 代理到 Docker 前端容器
    location / {
        proxy_pass http://127.0.0.1:80;  # FRONTEND_PORT in .env
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support (for terminal and chat)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Timeouts for long connections
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        # Disable buffering for real-time streaming
        proxy_buffering off;
        proxy_cache off;

        # Large file upload
        client_max_body_size 100m;
    }

    # SSL certificate validation (Let's Encrypt)
    location ~ \.well-known {
        allow all;
    }

    # Logs
    access_log /var/log/nginx/cc-platform.log;
    error_log /var/log/nginx/cc-platform.error.log;
}

# ===========================================
# Code-Server Subdomain Routing
# Code-Server 子域名路由
# ===========================================
#
# How it works / 工作原理:
#   1. User visits {container-name}.code.example.com
#   2. Nginx captures the subdomain and proxies to Traefik
#   3. Traefik routes to the correct container based on Host header
#
# Note / 注意:
#   Traefik HTTP port is dynamically allocated (default range: 38000-39000)
#   Check actual port: docker ps | grep cc-traefik
#   Or check backend logs for "Traefik created and started (HTTP: xxx)"
#
server {
    listen 80;
    server_name ~^(?<container>.+)\.code\.YOUR_CODE_DOMAIN$;  # e.g., *.code.example.com

    # Proxy to Traefik HTTP endpoint
    # 代理到 Traefik HTTP 入口点
    location / {
        # IMPORTANT: Change this to actual Traefik HTTP port
        # 重要：修改为 Traefik 实际的 HTTP 端口
        # Check with: docker ps | grep traefik
        proxy_pass http://127.0.0.1:TRAEFIK_HTTP_PORT;

        proxy_http_version 1.1;

        # Keep original Host header for Traefik routing
        # 保持原始 Host header 让 Traefik 路由
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support (required for code-server)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Timeouts for long connections
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        # Disable buffering
        proxy_buffering off;
        proxy_cache off;

        # Large file upload
        client_max_body_size 100m;
    }

    # Logs
    access_log /var/log/nginx/cc-code-server.log;
    error_log /var/log/nginx/cc-code-server.error.log;
}

# ===========================================
# Direct Port Access (Optional)
# 直接端口访问（可选）
# ===========================================
#
# For accessing container services via direct ports
# 用于通过直接端口访问容器服务
#
# Traefik direct port range: 30001-30020 (configurable in .env)
#
# Example: If a container exposes port 3000 and is assigned direct port 30005,
# users can access it at: http://example.com:30005
#
# If you want to proxy these through Nginx (recommended for SSL):
#
# server {
#     listen 80;
#     server_name port-30001.example.com;
#
#     location / {
#         proxy_pass http://127.0.0.1:30001;
#         # ... same proxy settings as above ...
#     }
# }

# ===========================================
# HTTPS Configuration (Recommended for Production)
# HTTPS 配置（生产环境推荐）
# ===========================================
#
# After obtaining SSL certificates (e.g., with certbot):
#
# server {
#     listen 443 ssl http2;
#     server_name YOUR_DOMAIN;
#
#     ssl_certificate /etc/letsencrypt/live/YOUR_DOMAIN/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/YOUR_DOMAIN/privkey.pem;
#
#     # SSL settings
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
#     ssl_prefer_server_ciphers off;
#
#     # HSTS
#     add_header Strict-Transport-Security "max-age=63072000" always;
#
#     # ... same location blocks as above ...
# }
#
# # Redirect HTTP to HTTPS
# server {
#     listen 80;
#     server_name YOUR_DOMAIN;
#     return 301 https://$server_name$request_uri;
# }
#
# For code-server subdomains, you need a wildcard certificate:
#   certbot certonly --manual --preferred-challenges dns -d "*.code.example.com"
