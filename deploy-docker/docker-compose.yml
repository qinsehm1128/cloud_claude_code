# ============================================
# Docker Compose Configuration
# Docker Compose 配置
# ============================================
#
# IMPORTANT / 重要:
#   Before starting, build the base images first:
#   启动前请先构建基础镜像:
#     ./build-base.sh
#
#   This creates:
#   这会创建:
#     - cc-base:latest (without code-server)
#     - cc-base:with-code-server (with code-server)
#
# Usage / 使用方法:
#   ./start.sh                        # Full deployment (recommended) / 完整部署（推荐）
#   docker compose up -d              # Start all services / 启动所有服务
#   docker compose up -d --build      # Rebuild and start / 重新构建并启动
#   docker compose down               # Stop all services / 停止所有服务
#   docker compose logs -f            # View logs / 查看日志
#
# Port mapping / 端口映射:
#   - Frontend: ${APP_PORT:-51080} -> Host Nginx -> Users
#   - Traefik:  ${TRAEFIK_HTTP_PORT:-51081} -> Host Nginx -> Code-Server
#
# ============================================

services:
  # ==========================================
  # Frontend Service (Nginx + React)
  # 前端服务 (Nginx + React)
  # ==========================================
  frontend:
    build:
      context: ..
      dockerfile: deploy-docker/Dockerfile.frontend
    container_name: cc-frontend
    restart: unless-stopped
    ports:
      # Map to high port, host nginx will proxy to this
      # 映射到高位端口，宿主机 nginx 会代理到此端口
      - "${APP_PORT:-51080}:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - cc-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

  # ==========================================
  # Backend Service (Go + Gin)
  # 后端服务 (Go + Gin)
  # ==========================================
  backend:
    build:
      context: ..
      dockerfile: deploy-docker/Dockerfile.backend
    container_name: cc-backend
    restart: unless-stopped
    expose:
      - "8080"
    volumes:
      # Data persistence / 数据持久化
      - cc-data:/app/data
      # Docker socket for container management / Docker socket 用于容器管理
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      # Core settings / 核心设置
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - PORT=8080
      - DATABASE_PATH=/app/data/cc-platform.db
      - DATA_DIR=/app/data
      # Security / 安全设置
      - JWT_SECRET=${JWT_SECRET}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-}
      # Admin credentials / 管理员凭据
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      # Traefik settings (fixed ports) / Traefik 设置（固定端口）
      - AUTO_START_TRAEFIK=${AUTO_START_TRAEFIK:-true}
      - TRAEFIK_HTTP_PORT=${TRAEFIK_HTTP_PORT:-51081}
      - TRAEFIK_DASHBOARD_PORT=${TRAEFIK_DASHBOARD_PORT:-51082}
      - TRAEFIK_PORT_RANGE_START=${TRAEFIK_PORT_RANGE_START:-30001}
      - TRAEFIK_PORT_RANGE_END=${TRAEFIK_PORT_RANGE_END:-30020}
      # Optional API keys / 可选 API 密钥
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - ANTHROPIC_BASE_URL=${ANTHROPIC_BASE_URL:-}
      - CODE_SERVER_BASE_DOMAIN=${CODE_SERVER_BASE_DOMAIN:-}
    networks:
      - cc-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "-O", "/dev/null", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    # Required for Docker socket access
    # 需要访问 Docker socket
    user: root

# ==========================================
# Networks / 网络
# ==========================================
networks:
  cc-network:
    driver: bridge
    name: cc-platform-network

# ==========================================
# Volumes / 卷
# ==========================================
volumes:
  cc-data:
    name: cc-platform-data
